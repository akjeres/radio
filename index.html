<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Radio Script</title>
    <style>
        audio {
            display: none !important;
        }
        .preloader {
            display: none;
        }
        .loading * {
            display: none;
        }
        .loading div.preloader {
            display: block;
        }
        .control,
        select {
            cursor: pointer;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>
        var radio = null;
        var player = radio;
        var playButton = player;
        var volumeControl = playButton;
        var select = volumeControl;
        var isPaused = true;
        var isMuted = false;
        var volume = 1;
        var playTxt = '&#9658;';
        var pauseTxt = '&#9612;&#9612;';
        var eventEnabled = false;
        console.log('script. eventEnabled: ', eventEnabled);


        window.addEventListener('load', function(event) {
            console.log('window loaded');
            console.log('window loaded. eventEnabled: ', eventEnabled);
            // Audio tag
            radio = document.getElementById('audio');
            // Player
            player = document.querySelector('.player');

                // Play/Pause button
            playButton = player.querySelector('.control');
            playButton.dataset['paused'] = Number(isPaused);
            playButton.innerHTML = isPaused ? playTxt : pauseTxt;
            playButton.addEventListener('click', function(e) {
                isPaused = playButtonHanler(this, playAudio, stopAudio);
            }, false);

            // Enable events
            eventEnabled = true;
            console.log('events enabled. eventEnabled: ', eventEnabled);

            // Radio event Listeners
            radio.addEventListener('progress', progressListener);
            radio.addEventListener('loadeddata', enableBodyListener);
            radio.addEventListener('seeked', function(event) {
                console.log('seeked');
            });
            radio.addEventListener('error', function(event) {
                console.log('error');
                stopAudio();
                this.removeEventListener('stalled', stalledHandler);
            });
            // Select event Listeners
            select = document.getElementById('src_select');
            select.addEventListener('change', selectChange);

            document.body.classList.remove('loading');
        });

        function playButtonHanler(button, playHandler, pauseHandler) {
            if (!eventEnabled) return;

            eventEnabled = false;
            button.dataset['paused'] = Number(!Number(button.dataset['paused']));
            var txt;
            var result = Number(button.dataset['paused']);
            if (result) {
                txt = playTxt;
                pauseHandler();
            } else {
                txt = pauseTxt;
                playHandler();
            }
            button.innerHTML = txt;

            return Number(button.dataset['paused']);
        };

        function playAudio() {
            document.body.classList.add('loading');
            var srcSelect = document.getElementById('src_select');
            var value = JSON.parse(srcSelect['value']);
            console.log('play');
            radio.src = value['src'];
            radio.addEventListener('stalled', stalledHandler);
            radio.play();
        }
        function stopAudio() {
            console.log('audio is stopped now');

            if (radio) {
                radio.pause();
                radio.currentTime = 0;
            }
            isPaused = true;
            eventEnabled = true;
            playButton.innerHTML = playTxt;
            document.body.classList.remove('loading');
        }
        function progressListener() {
            eventEnabled = false;
            isPaused = this.paused;
            isMuted = this.muted;
            console.log('paused: ', isPaused);
            console.log('muted: ', this.muted);
            var txt = pauseTxt;
            if (isPaused) {
                txt = playTxt;
            }
            playButton.innerHTML = txt;
            playButton.dataset['paused'] = Number(isPaused);
            document.body.classList.remove('loading');
            eventEnabled = true;
        }

        function enableBodyListener() {
            console.log(this);
            console.log('loadeddata');
                if(this.readyState >= 2) {
                    console.log('audio is playing now');
                    document.body.classList.remove('loading');
                    eventEnabled = true;
                } else {
                    console.log('there was some error while loading audio');
                    stopAudio();
                }
        }

        function selectChange() {
            eventEnabled = false;
            var self = this;
            var value = JSON.parse(self['value']);
            if (isPaused) {
                eventEnabled = true;
                return;
            }
            stopAudio();
            playAudio();

            console.log('changed: ', self);
            console.log('value: ', value);
            console.log('isPaused: ', isPaused);
            eventEnabled = true;
        }

        function stalledHandler() {
            console.log('stalled');
            document.body.classList.add('loading');
            stopAudio();
            playAudio();
        }
    </script>
</head>
<body class="loading">
    <div class="preloader">Loading</div>
    <div class="player"><button class="control"></button></div>
    <select name="src_select" id="src_select">
        <option value='{"src":"http://online.hitfm.ua/HitFM_HD","request":"https://o.tavrmedia.ua/hit"}'>Hit FM</option>
        <option value='{"src":"http://online.kissfm.ua/KissFM","request":"https://o.tavrmedia.ua/kiss"}'>KISS FM</option>
    </select>
    <audio id="audio" controls="true" preload="none" src=""></audio>
    <ul class="palylist"></ul>
</body>
</html>