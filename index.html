<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Radio Script</title>
    <style>
        * {
            font-family: monospace;
        }
        audio {
            display: none !important;
        }
        .preloader {
            display: none;
        }
        .loading * {
            display: none;
        }
        .loading div.preloader {
            display: block;
        }
        .control,
        select {
            cursor: pointer;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>
        var radio = null;
        var player = radio;
        var playButton = player;
        var volumeLevel = playButton;
        var select = volumeLevel;
        var muteButton = select;
        var isPaused = true;
        var isMuted = false;
        var volume = 1;
        var playTxt = '&#9658;';
        var pauseTxt = '&#9612;&#9612;';
        var muteTxt = '&#128263;';
        var speakerTxt = [
            '&#128264;',
            '&#128265;',
            '&#128266;',
        ];
        var eventEnabled = false;
        console.log('script. eventEnabled: ', eventEnabled);


        window.addEventListener('load', function(event) {
            console.log('window loaded');
            console.log('window loaded. eventEnabled: ', eventEnabled);
            // Document entities
                radio = document.getElementById('audio');               // Audio
                player = document.querySelector('.player');             // Player
                muteButton = player.querySelector('.mute-button');      // Mute button
                volumeLevel = player.querySelector('.volume-level');  // Volume level

            // Player
                // Play/Pause button
            playButton = player.querySelector('.play-button');
            playButton.dataset['paused'] = Number(isPaused);
            playButton.innerHTML = isPaused ? playTxt : pauseTxt;
            playButton.addEventListener('click', function(e) {
                isPaused = playButtonHanler(this, playAudio, stopAudio);
            }, false);
                // Mute button
            setMuteButtonText(muteButton);
            muteButton.addEventListener('click', function(e) {
                isMuted = !isMuted;
                radio['muted'] = isMuted;
                setMuteButtonText(this);
                console.log('radio.muted: ', radio.muted);
                console.log('isMuted: ', isMuted);
                if (isMuted) {
                    volumeLevel['value'] = 0;
                } else {
                    volumeLevel['value'] = volume;
                }
            });
                // Volume level
            volumeLevel.addEventListener('input', function(e) {
                var value = Number(this['value']);

                radio['muted'] = !value;
                isMuted = !value;
                volume = value;
                radio['volume'] = value;

                setMuteButtonText(muteButton);
            });

            // Radio event Listeners
            radio.addEventListener('progress', progressListener);
            radio.addEventListener('loadeddata', enableBodyListener);
            radio.addEventListener('seeked', function(event) {
                console.log('seeked');
            });
            radio.addEventListener('error', function(event) {
                console.log('error');
                stopAudio();
                this.removeEventListener('stalled', stalledHandler);
            });
            // Select event Listeners
            select = document.getElementById('src_select');
            select.addEventListener('change', selectChange);

            document.body.classList.remove('loading');
            // Enable events
            eventEnabled = true;
            console.log('events enabled. eventEnabled: ', eventEnabled);
        });

        function playButtonHanler(button, playHandler, pauseHandler) {
            if (!eventEnabled) return;

            eventEnabled = false;
            button.dataset['paused'] = Number(!Number(button.dataset['paused']));
            var txt;
            var result = Number(button.dataset['paused']);
            if (result) {
                txt = playTxt;
                pauseHandler();
            } else {
                txt = pauseTxt;
                playHandler();
            }
            button.innerHTML = txt;

            return Number(button.dataset['paused']);
        };

        function playAudio() {
            document.body.classList.add('loading');
            var srcSelect = document.getElementById('src_select');
            var value = JSON.parse(srcSelect['value']);
            console.log('play');
            radio.src = value['src'];
            radio.addEventListener('stalled', stalledHandler);
            radio.play();
        }
        function stopAudio() {
            console.log('audio is stopped now');

            if (radio) {
                radio.pause();
                radio.currentTime = 0;
            }
            isPaused = true;
            eventEnabled = true;
            playButton.innerHTML = playTxt;
            document.body.classList.remove('loading');
        }
        function progressListener() {
            eventEnabled = false;
            isPaused = this.paused;
            isMuted = this.muted;
            console.log('paused: ', isPaused);
            console.log('muted: ', this.muted);
            var txt = pauseTxt;
            if (isPaused) {
                txt = playTxt;
            }
            playButton.innerHTML = txt;
            playButton.dataset['paused'] = Number(isPaused);
            document.body.classList.remove('loading');
            eventEnabled = true;
        }

        function enableBodyListener() {
            console.log(this);
            console.log('loadeddata');
                if(this.readyState >= 2) {
                    console.log('audio is playing now');
                    document.body.classList.remove('loading');
                    eventEnabled = true;
                } else {
                    console.log('there was some error while loading audio');
                    stopAudio();
                }
        }

        function selectChange() {
            eventEnabled = false;
            var self = this;
            var value = JSON.parse(self['value']);
            if (isPaused) {
                eventEnabled = true;
                return;
            }
            stopAudio();
            playAudio();

            console.log('changed: ', self);
            console.log('value: ', value);
            console.log('isPaused: ', isPaused);
            eventEnabled = true;
        }

        function stalledHandler() {
            console.log('stalled');
            document.body.classList.add('loading');
            stopAudio();
            playAudio();
        }

        function setMuteButtonText(node) {
            if (radio.muted) {
                node.innerHTML = muteTxt;
                return;
            }

            node.innerHTML = speakerTxt[getDiapason(radio['volume'])];
        }

        function getDiapason(num) {
            if (num > 1 || num > 2/3) return 2;

            if (num > 1/3) return 1;

            return 0;
        }

    </script>
</head>
<body class="loading">
    <div class="preloader">Loading</div>
    <div class="player">
        <button class="control play-button"></button>
        <button class="control mute-button"></button>
        <input type="range" name="volume-level" class="control volume-level" min="0" max="1" step="0.01" value="1">
    </div>
    <select name="src_select" id="src_select">
        <option value='{"src":"http://online.hitfm.ua/HitFM_HD","request":"https://o.tavrmedia.ua/hit","name":"Hit FM"}'>Hit FM</option>
        <option value='{"src":"http://online.kissfm.ua/KissFM","request":"https://o.tavrmedia.ua/kiss","name":"KISS FM"}'>KISS FM</option>
    </select>
    <audio id="audio" controls="true" preload="none" src=""></audio>
    <ul class="palylist"></ul>
</body>
</html>