<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Radio Script</title>
    <style>body{margin:0;padding:0}body.mobile button{margin:0 auto 0 8px}body.mobile button:first-child{margin:0 7px 0 auto}.app{width:-webkit-calc(100% - 30px);width:calc(100% - 30px);margin:15px auto auto auto;max-width:400px}.preloader{position:fixed;width:100%;height:100%;top:0;left:0;z-index:1;text-align:center;background:#fff;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-webkit-align-items:center;-ms-flex-align:center;align-items:center}.preloader span{display:block;margin:auto;font-size:1.5em}*{font-family:monospace}option{font-family:inherit}.mobile .volume-level,audio{display:none!important}.loading *,.preloader{display:none}.loading div.preloader{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex}.control,select{cursor:pointer}button{width:35px;height:35px;display:block;margin-right:15px;background:none center no-repeat buttonface;-webkit-background-size:20px 20px;background-size:20px}.player{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:start;-webkit-justify-content:flex-start;-ms-flex-pack:start;justify-content:flex-start;-webkit-box-align:stretch;-webkit-align-items:stretch;-ms-flex-align:stretch;align-items:stretch;margin-bottom:15px}.player_title{margin:0 auto 15px auto;text-align:center}.volume-level{display:block;margin:0;-webkit-box-flex:1;-webkit-flex:1;-ms-flex:1;flex:1}.playlist_wrapper{margin-bottom:15px}.playlist_wrapper:last-child{margin-bottom:0}.playlist_title{text-align:center;margin:0 auto 15px auto}.playlist{padding:0;margin:0;list-style:none}.station_select{display:block;width:100%;height:35px;margin:0 auto 15px auto;text-align:center}.playlist_item{margin-bottom:5px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:start;-webkit-justify-content:flex-start;-ms-flex-pack:start;justify-content:flex-start;-webkit-box-align:center;-webkit-align-items:center;-ms-flex-align:center;align-items:center}.playlist_item__logo{display:block;width:35px;height:35px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:15px;background:none center no-repeat buttonface}.playlist_item:last-child{margin-bottom:0}</style>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        window.mobileAndTabletcheck = function() {
            var check = false;
            (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
            return check;
        };
        var radio = null;
        var player = radio;
        var playButton = player;
        var volumeLevel = playButton;
        var select = volumeLevel;
        var muteButton = select;
        var timerID = muteButton;
        var appTitle = timerID;
        var currentList = appTitle;
        var previousList = currentList;
        var isPaused = true;
        var isMuted = false;
        var volume = 1;
        var delay = 7500;
        var playTxt = 'play';
        var pauseTxt = 'pause';
        var muteTxt = 'mute';
        var speakerTxt = [
            'speaker-0',
            'speaker-1',
            'speaker-2',
            'speaker-3',
        ];
        var imagePrefix = './icons/';
        var imageSuffix = '.svg';
        var eventEnabled = false;
        console.log('script. eventEnabled: ', eventEnabled);
        (function() {
            var imgsArr = [
                'mute',
                'pause',
                'play',
                'speaker-0',
                'speaker-1',
                'speaker-2',
                'speaker-3',
            ];
            imgsArr.forEach(function (i) {
                var item = document.createElement('img');
                item['src'] = imagePrefix + i + imageSuffix;
            });
        })();
        const CancelToken = axios.CancelToken;
        let cancel;
        var getTrackData = (url, current, previous) => axios.get(url, {
            cancelToken: new CancelToken(function executor(c) {
                // An executor function receives a cancel function as a parameter
                cancel = c;
            })
        })
            .then(function (response) {
                var data = response['data'].concat();
                var currentData = data.shift();
                renderData(current, currentData);
                renderData(previous, data);
            })
            .catch(function (error) {
                // handle error
                console.log(error);
            })
            .finally(function() {
                document.body.classList.remove('loading');
                eventEnabled = true;
            });
        window.addEventListener('load', function(event) {
            if (mobileAndTabletcheck()) {
                document.body.classList.add('mobile');
            }
            console.log('window loaded');
            console.log('window loaded. eventEnabled: ', eventEnabled);
            // Document entities
            radio = document.getElementById('audio');               // Audio
            player = document.querySelector('.player');             // Player
            muteButton = player.querySelector('.mute-button');      // Mute button
            volumeLevel = player.querySelector('.volume-level');    // Volume level
            appTitle = document.querySelector('.player_title');     // Application title
            currentList = document.querySelector('.current');       // Current playing
            previousList = document.querySelector('.previous');     // Previously played
            // Player
            // Play/Pause button
            playButton = player.querySelector('.play-button');
            playButton.dataset['paused'] = Number(isPaused);
            var pauseValue = isPaused ? playTxt : pauseTxt;
            setText(playButton, pauseValue, imagePrefix, imageSuffix);
            playButton.addEventListener('click', function(e) {
                isPaused = playButtonHanler(this, playAudio, stopAudio);
            }, false);
            // Mute button
            setMuteButtonText(muteButton);
            muteButton.addEventListener('click', function(e) {
                isMuted = !isMuted;
                radio['muted'] = isMuted;
                setMuteButtonText(this);
                if (isMuted) {
                    volumeLevel['value'] = 0;
                } else {
                    volumeLevel['value'] = volume * 100;
                }
            });
            // Volume level
            volumeLevel.addEventListener('change', volumeLevelHandler);
            volumeLevel.addEventListener('input', volumeLevelHandler);

            // Radio event Listeners
            radio.addEventListener('progress', progressListener);
            radio.addEventListener('loadeddata', enableBodyListener);
            radio.addEventListener('seeked', function(event) {
                console.log('seeked');
            });
            radio.addEventListener('error', function(event) {
                console.log('error');
                console.error(event['message']);
                stopAudio();
            });
            // Select event Listeners
            select = document.getElementById('src_select');
            select.addEventListener('change', selectChange);

            document.body.classList.remove('loading');
            timerID = setTimeout(function request() {
                getTrackData(JSON.parse(select['value'])['request'], currentList, previousList);
                timerID = setTimeout(request, delay);
            },0);
            // Enable events
            eventEnabled = true;
            console.log('events enabled. eventEnabled: ', eventEnabled);
        });

        function playButtonHanler(button, playHandler, pauseHandler) {
            if (!eventEnabled) return;

            eventEnabled = false;
            button.dataset['paused'] = Number(!Number(button.dataset['paused']));
            var txt;
            var result = Number(button.dataset['paused']);
            if (result) {
                txt = playTxt;
                pauseHandler();
            } else {
                txt = pauseTxt;
                playHandler();
            }
            setText(button, txt, imagePrefix, imageSuffix);

            return Number(button.dataset['paused']);
        };

        function playAudio() {
            document.body.classList.add('loading');
            var srcSelect = document.getElementById('src_select');
            var value = JSON.parse(srcSelect['value']);
            radio.src = value['src'];
            radio.addEventListener('stalled', stalledHandler);
            radio.play();
        };
        function stopAudio() {
            if (radio) {
                radio.pause();
                radio.currentTime = 0;
            }
            cancel();
            clearTimeout(timerID);
            isPaused = true;
            eventEnabled = true;
            setText(playButton, playTxt, imagePrefix, imageSuffix);
            document.body.classList.remove('loading');
        };
        function progressListener() {
            eventEnabled = false;
            isPaused = this.paused;
            isMuted = this.muted;
            console.log('paused: ', isPaused);
            console.log('muted: ', this.muted);
            var txt = pauseTxt;
            if (isPaused) {
                txt = playTxt;
            }
            setText(playButton, txt, imagePrefix, imageSuffix);
            playButton.dataset['paused'] = Number(isPaused);
            document.body.classList.remove('loading');
            eventEnabled = true;
        };

        function enableBodyListener() {
            var txt = 'play';
            if(this.readyState >= 2) {
                txt = 'pause';
                document.body.classList.remove('loading');
                eventEnabled = true;
            } else {
                console.log('there was some error while loading audio');
                stopAudio();
            }
            setText(playButton, txt, imagePrefix, imageSuffix);
        };

        function selectChange() {
            eventEnabled = false;
            var self = this;
            var value = JSON.parse(self['value']);
            document.body.classList.remove('loading');
            if (radio['paused']) {
                document.body.classList.remove('loading');
            } else {
                stopAudio();
                playAudio();
            }
            appTitle.textContent = value['name'];
            timerID = setTimeout(function request() {
                getTrackData(value['request'], currentList, previousList);
                timerID = setTimeout(request, delay);
            },0);
            eventEnabled = true;
        };

        function stalledHandler() {
            console.log('stalled');
            document.body.classList.add('loading');
            stopAudio();
            playAudio();
        };

        function setMuteButtonText(node) {
            if (radio.muted) {
                node.style.backgroundImage = 'url(' + imagePrefix + muteTxt + imageSuffix + ')';
                return;
            }

            node.style.backgroundImage = 'url(' + imagePrefix + speakerTxt[getDiapason(radio['volume'])] + imageSuffix + ')';
        };

        function getDiapason(num) {
            if (num >= 1) return 3;

            if (num > 1/2) return 2;

            if (num > 0) return 1;

            return 0;
        };

        function volumeLevelHandler() {
            var value = this['value'];
            var valueForDec = Number(value/100);

            volume = valueForDec;
            radio['volume'] = valueForDec;

            setMuteButtonText(muteButton);
        };

        function renderData(node, data) {
            if (!Array.isArray(data)) {
                data = [data];
            }
            while (node.firstChild) node.removeChild(node.firstChild);
            Array.prototype.forEach.call(data, function (i) {
                node.appendChild(renderItem(i));
            });
        }

        function setText(destination, value, prefix, suffix) {
            destination.style.backgroundImage = 'url(' + prefix + value + suffix + ')';
        }

        function renderItem(data) {
            var img = data['cover'] ? 'background-image:url(' + data['cover'] + ')' : '';
            var result = document.createElement('li');
            var logo = document.createElement('span');
            var info = document.createElement('span');
            var singer = document.createElement('span');
            var separator = document.createElement('span');
            var song = document.createElement('span');
            result.className = 'playlist_item';
            logo.className = 'playlist_item__logo';
            info.className = 'playlist_item__info';
            singer.className = 'playlist_item__singer';
            separator.className = 'playlist_item__separator';
            song.className = 'playlist_item__song';
            logo.style = img;
            singer.textContent = data['singer'];
            separator.innerHTML = '&nbsp;&mdash;&nbsp;';
            song.textContent = data['song'];
            result.appendChild(logo);
            info.appendChild(singer);
            info.appendChild(separator);
            info.appendChild(song);
            result.appendChild(info);

            return result;
        }


    </script>
</head>
<body class="loading">
<div class="preloader"><span>Loading</span></div>
<div class="app">
    <h1 class="player_title">Hit FM</h1>
    <div class="player">
        <button class="control play-button"></button>
        <button class="control mute-button"></button>
        <input type="range" name="volume-level" class="control volume-level" min="0" max="100" step="1" value="100">
    </div>
    <select class="station_select" name="src_select" id="src_select">
        <option value='{"src":"http://online.hitfm.ua/HitFM_HD","request":"https://o.tavrmedia.ua/hit","name":"Hit FM"}'>Hit FM</option>
        <option value='{"src":"http://online.kissfm.ua/KissFM","request":"https://o.tavrmedia.ua/kiss","name":"KISS FM"}'>KISS FM</option>
    </select>
    <audio id="audio" controls="true" preload="none" src=""></audio>
    <article class="playlist_wrapper">
        <h2 class="playlist_title">Is playing now</h2>
        <ul class="playlist current"></ul>
    </article>
    <article class="playlist_wrapper">
        <h2 class="playlist_title">Was playing previously</h2>
        <ul class="playlist previous"></ul>
    </article>
</div>
</body>
</html>